<%= form_for([:admin,@store_entry]) do |f| %>
  <%= error_messages @store_entry %>
  <div id="show_info">
    <h1>新建入库单</h1>
    <ul>
      <li>
        <%= symbol_label "入库记录编号" %>
        <span>(系统自动生成)</span>
      </li>
      <li>
        <%= symbol_label "入库时间" %>
        <span><%= Time.now %></span>
      </li>
      <li>
        <%= symbol_label "操作人" %>
        <span><%= current_administrator.name %></span>
        <hr />
      </li>
      <li>
        <%= f.label "收货仓库" %>
        <span><%= f.collection_select :store_id, Store.all, :id, :name %></span>
      </li>
      <li>
        <%= f.label "入库类型" %>
        <span><%= f.collection_select :store_in_type, StoreEntry::STORE_IN_TYPE.find_all { |key,value| [key, value] if key != 1 }, :first, :second %></span>
      </li>
    </ul>

    <hr />

    <table class="grid">
      <thead>
        <tr>
          <th>#</th>
          <th>商品编码</th>
          <th>商品名称</th>
          <th>规格</th>
          <th>型号</th>
          <th>单位</th>
          <th>数量</th>
          <th>交货日期</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="product_carts">
        <% @store_entry_product_carts.each_with_index do |product,index| %>
          <tr class="<%= set_odd_even_class(index) %>">
            <td><%= index+1 %></td>
            <td><%= product.product.product_id %></td>
            <td><%= product.product.name %></td>
            <td><%= product.product.specification %></td>
            <td><%= product.product.model %></td>
            <td><%= product.product.unit %></td>
            <td><input type="text" size="3"  value="<%= product.quantity %>" onchange="update_cart('<%= product.id %>',this.value,1)"/></td>
            <% if product.cart_type == 0 %>
              <td><input type="text" size="5"  value="<%= product.unit_price_aft_tax %>" onchange="update_cart('<%= product.id %>',this.value,3)"/></td>
              <td><input type="text" size="5"  value="<%= product.total_amount %>" onchange="update_cart('<%= product.id %>',this.value,4)"/></td>
            <% end  %>
            <td><input type='text' value="<%= product.delivery_date %>" class="delivery_date"  onchange="update_cart('<%= product.id %>',this.value,2)"/></td>
            <td><a href="#" onclick="destroy_cart('<%= product.id %>','<%= product.cart_type %>')">删除</a></td>
          </tr>
        <% end %>

        <script type="text/javascript">
          $(".delivery_date").datepicker({ dateFormat: 'yy-mm-dd' });

          function update_cart(id,value,type){
            jQuery.ajax({ type: 'put', //提交的类型
                          url: '/admin/store_entry_product_carts/'+id,//提交地址
                          data: 'value='+value+'&type='+type,//参数  type:{1:数量,2:日期,3:单价,4:总计}
                          success: function(msg){ //回调方法
                          }});
          }

          function destroy_cart(id,cart_type){
            jQuery.ajax({ type: 'delete', //提交的类型
                          url: '/admin/store_entry_product_carts/'+id,//提交地址
                          data: 'cart_type='+cart_type,//参数
                          success: function(msg){ //回调方法
                            $('#product_carts').html(msg);
                          }});
          }
        </script>
      </tbody>
    </table>

    <div class="attributes margin_top_20">
      商品编号:<%= text_field_tag 'q[product_id_eq]' %>
      商品名称:<%= text_field_tag 'q[name_cont]' %>
      <input type="button" value="查询" id="product_search_btn" />
    </div>

    <table class="grid">
      <thead>
        <tr>
          <th>#</th>
          <th>商品编码</th>
          <th>商品名称</th>
          <th>规格</th>
          <th>型号</th>
          <th>单位</th>
          <th>添加</th>
        </tr>
      </thead>
      <tbody id="search_product"></tbody>
    </table>
    <p>
      <%= f.label '备注', :style => "float:none;" %>
      <%= f.text_area :note, :cols => 100, :rows => 5 %>
    </p>
    <%= f.submit '确认入库' %>
    <input type="button" value="关闭页面" onclick="return window.close()" />
  </div>
<% end %>



<script type="text/javascript">
  jQuery("#product_search_btn").click(function(){
    jQuery.ajax({ type: 'get', //提交的类型
                  url: '/admin/products/search',
                  data: {"cart_type":1,"q[product_id_eq]":jQuery("#q_product_id_eq").val(),"q[name_cont]":jQuery("#q_name_cont").val()},
                  dataType:'script'
    });
  });
</script>
